---
title: "UQM paper outputs"
author: "KZ"
date: "29 June 2015"
output: html_document
---
  

```{r, echo=FALSE, message=FALSE}
#clean workspace
rm(list=ls())

#packages
#require(RCurl)
# require(bitops)
require(reshape2)
require(dplyr)

#load data
#folder = "./Data Stage 2/"
demog = read.csv("./Data Stage 2/demog.csv", header=TRUE, stringsAsFactors=FALSE)
AcP = read.csv("./Data Stage 2/AcPdf.csv", header=TRUE, stringsAsFactors=FALSE)
FbPsum = read.csv("./Data Stage 2/FbPsummary.csv", header=TRUE, stringsAsFactors=FALSE)
FbP = read.csv("./Data Stage 2/FbPdf.csv", header=TRUE, stringsAsFactors=FALSE)
FbU = read.csv("./Data Stage 2/FbUdf.csv", header=TRUE, stringsAsFactors=FALSE)
AcPFbUbins = read.csv("./Data Stage 2/AcPFbUbins.csv", header=TRUE, stringsAsFactors=FALSE)


#load functions
source("UQM functions.R")
source("HelperFunctions.R")

ProjectID = read.csv("./Data Stage 1/ProjectIDs.csv")
projects()
graphs()

stats.mean.sem = function(df, dv, iv)
{
  means = tapply(df[,dv], df[,iv], mean, na.rm=T)
  st.dev = tapply(df[,dv], df[,iv], sd, na.rm=T)
  n = tapply(df[,dv], df[,iv], length)
  SEM = st.dev/sqrt(n)
  stats = as.data.frame(means)
  stats = cbind(stats, SEM)
  return(stats)
}

#Generalising
gen = function(df, col.course, col.sem){
  df[,col.course] = gsub("BIOL1040", "Level 1", df[,col.course])
  df[,col.course] = gsub("BIOM2011", "Level 2", df[,col.course])
  df[,col.sem] = gsub("Sem1", "Semester 1", df[,col.sem])
  df[,col.sem] = gsub("Sem2", "Semester 2", df[,col.sem])
  return(df)
}

demog = gen(demog, 13, 14)
AcP = gen(AcP, 7, 8)
#FbPsum does not inlude project details, need to merge in from AcP
#FbP.sum = merge(FbPsum, AcP, by="SubmissionID", all.y=T)
#FbP.sum[which(is.na(FbP.sum[,2])),] #bunch of Submissions for which there are marks but no meta-data on Fb provision - possible error in generating FbPsummary?
#ignoring this for now and just generating Fig 2-4 based on data that is in FbPsummary.csv
FbP.AcP = merge(FbPsum, AcP, by="SubmissionID")

```


#Methods
##Student cohort  
```{r, echo=FALSE}
df = subset(demog, Course.Grade !="withrawn")
temp = df %>% group_by(course, sem) %>% tally()
temp2 = as.data.frame(round(prop.table(table(df[,5])),2)*100)

df[,4] = as.Date(df[,4], "%d/%M/%Y")
sem1 = as.Date("2013-03-01")
df2 = df %>% select(Date.of.Birth) %>% mutate(sem1 - Date.of.Birth)
df2$age = as.numeric(df2[,2])%/%365
#df2[1:10,]
#table(df2[,3])
bins = c(0, 16, 21, 60)
df2$age.bin = cut(df2[,3], bins)
#head(df2, n=20)
temp3 = as.data.frame(round(prop.table(table(df2$age.bin)),2)*100)

temp4 = as.data.frame(round(prop.table(table(df$International.Indicator.Code)),2)*100)
#temp4 = as.data.frame(round(prop.table(table(df$International.Indicator.Code)),2)*100)
#round(prop.table(table(df$UQ.Translated.Base.OP)),2)*100

bin.op = c(0, 8, 20)

temp5 = as.data.frame(round(prop.table(table(cut(df$UQ.Translated.Base.OP, bin.op))),2)*100)

```


During the period of this study, there were `r temp[1,3]` and `r temp[2,3]` students enrolled in the level 1 course, and `r temp[3,3]` and `r temp[3,3]` students enrolled in the level 2 course in 2013 Semesters 1 and 2, respectively. There were slightly more `r tolower(temp2[1,1])` (`r temp2[1,2]`%) than `r tolower(temp2[2,1])` (`r temp2[2,2]`%)  students, the vast majority (`r temp3[2,2]`%) were 17 â€“ 21 years old, domestic students (`r temp4[1,2]`%), with high- to mid-range university entry scores (`r temp5[1,2]`%). 


**_need to get program data to check the following:_**    
Just over half (53%) of the students taking these courses were enrolled in a three-year Bachelor of Science (BSc) or four-year dual degree combining BSc with another degree, or the Bachelor of Biomedical Science (four year research-focused program). An additional 21% were enrolled in one of four sports science degrees, and 12% were enrolled in the combined BSc/Medical program (in which students undertake an accelerated two-year BSc program and then enter a four-year, graduate entry Medical program). The remaining students were enrolled in a large range of single and dual degrees (e.g. Arts, Engineering), specialty degrees and applied science degrees.  


##Data collection and analysis  
```{r, echo=FALSE}
temp = length(unique(AcP$SubmissionID))
```
A total of `r temp` reports submitted and marked through FACS in semester 1 and 2, 2013 were used for this study. The modality, length (in time or number of words) and position of each feedback annotation provided on all reports was recorded, and the time taken to mark each collated. Clickstream data logs were collected as students accessed their marked documents, providing information on opening dates and durations, and student interaction with the feedback annotations. Data on student academic performance for each report were also collated. Throughout this study, quantitative analyses were performed using R 3.1.1 (R Development Core Team, Auckland, NZ). The results were expressed as mean and standard error of the mean (SEM), and were considered significant if p<0.05. 

#Results and Discussion    
```{r, echo=FALSE, warning=FALSE, message=FALSE}
temp = dcast(AcP, course + sem ~ report)
#temp
df = subset(demog, Course.Grade !="withrawn")
temp2 = as.data.frame(df %>% group_by(course) %>% tally())
```

The increasing availability of online technologies, which allow the provision of multimodal feedback annotations that can be generalised or situated, has certainly increased the variety and flexibility of feedback delivery options (refs). However, it has also increased the variability of feedback provision and changed the way in which students interact with feedback, leading to potentially greater variability in student outcomes (refs). The primary aims of this study were to understand how the different modalities of feedback available through online technologies affected feedback provisionboth across successive student assessment tasks and within large cohorts with multiple markers, and to examine the way students interacted with the feedback provided. Analyses of FACS data from laboratory reports submitted for assessment (Table 1) in two biomedical science courses in level 1 (n = `r temp2[1,2]` students) and level 2 (n = `r temp2[2,2]`), in Semesters 1 and 2, 2013, have shown that there are significant differences in the ways in which markers use the different modalities of feedback (Figure 2-4). In addition, the data demonstrates that there are substantial differences in the way students interact with their marked reports and feedback within them across the semesters (Figures 5-8).

Table 1: Number of assignments processed through FACS  
```{r, echo=FALSE}
temp
```
NB Report 4 for the level 1 course in semester 2 was administered by another academic department which did not participate in the FACS trial.



```{r, echo=FALSE, fig.width=10, fig.height=5}

plot.topper.dual()

plot.mean.sem(FbP.AcP, 4, 14, 20, report.col, report.names, "Number of audio annotations per report")
plot.mean.sem(FbP.AcP, 5, 14, 20, report.col, report.names, "Number of text annotations per report")

legend.top(sem.names,  kz.col)

temp = as.data.frame(table(FbP.AcP[,15], FbP.AcP[,17]))

```

Figure 2: Number of audio and text annotations for level 1 course (Report 0: n=`r temp[1,3]`, Report 1: n=`r temp[3,3]`, Report 2: n=`r temp[5,3]`, Report 3: n=`r temp[7,3]`) and for the level 2 course (Report 1: n=`r temp[4,3]`, Report 2: n=`r temp[6,3]`). Shown is the A)  mean+/-SEM number of audio annotations per report across two semesters of level 1 and 2 subjects; B)  mean+/-SEM number of text annotations per report across two semesters of level 1 and 2 subjects.


```{r, echo=FALSE, fig.width=10, fig.height=5}

audio = subset(FbP, AnnotType == "Recording")
text = subset(FbP, AnnotType == "Text")

plot.topper.dual()

plot.mean.sem(audio, 18, 14, 170, report.col, report.names, "Number of words per audio annotation \n per report")
plot.mean.sem(text, 18, 14, 17, report.col, report.names, "Number of words per text annotation \n per report")

legend.top(sem.names,  kz.col)

temp = as.data.frame(table(FbP.AcP[,15], FbP.AcP[,17]))

#Kay wanted range of audio durations (sec) for later text
#temp3 = as.data.frame(tapply(FbP[,12], FbP[,14], mean, na.rm=T))
#temp4 = NULL
#for(i in 1:11)
#  temp4[[i]] = se(subset(FbP, project == project.names.formative[i]), 12)
#temp3
#temp4  
  
```

Figure 3: Number of words provided in each audio and text annotation for level 1 course (Report 0: n=`r temp[1,3]`, Report 1: n=`r temp[3,3]`, Report 2: n=`r temp[5,3]`, Report 3: n=`r temp[7,3]`) and for the level 2 course (Report 1: n=`r temp[4,3]`, Report 2: n=`r temp[6,3]`). Shown is the A) mean+/-SEM number of words in each audio annotation in reports across two semesters and levels; B) mean+/-SEM number of words in each text annotation in reports across two semesters and two levels. *NB The y-axis scale for A is 10x the y-axis scale for B.*


```{r, echo=FALSE, fig.width=10, fig.height=5}

plot.topper.dual()

plot.mean.sem(FbP.AcP, 8, 14, 1700, report.col, report.names, "Number of words in audio annotations per report")
plot.mean.sem(FbP.AcP, 9, 14, 170, report.col, report.names, "Number of words in text annotations per report")

legend.top(sem.names,  kz.col)

temp = as.data.frame(table(FbP.AcP[,15], FbP.AcP[,17]))

```

Figure 4: Total amount of feedback provided in audio and text feedback for level 1 course (Report 0: n=`r temp[1,3]`, Report 1: n=`r temp[3,3]`, Report 2: n=`r temp[5,3]`, Report 3: n=`r temp[7,3]`) and for the level 2 course (Report 1: n=`r temp[4,3]`, Report 2: n=`r temp[6,3]`). Shown is the A) mean+/-SEM number of words in audio annotations in reports across two semesters and levels; B) mean+/-SEM number of words in text annotations in reports across two semesters and two levels. *NB The y-axis scale for A is 10x the y-axis scale for B.*




```{r, echo=FALSE, fig.width=10, fig.height=5}

looked = as.data.frame(addmargins(prop.table(table(AcPFbUbins[,6], AcPFbUbins[,11]),1)))
looked = round(100-(looked[37:47,3]*100),2)
#looked

default.plot()

barplot(looked, names = report.names, las=2, col=report.col, ylim=c(0,100), ylab="Number of Students (% of cohort)", axis.lty=1.0)

legend.top(sem.names,  kz.col)


temp = as.data.frame(table(AcP[,6]))


```


Figure 5: The proportion of students who looked at their feedback (shown as the proportion of students who received feedback in each cohort). Number of students in each cohort: Level one semester 1: n=`r temp[1,2]`; Level one semester 2: n=`r temp[5,2]`; Level two semester 1: n=`r temp[8,2]`; Level two semester 2: n=`r temp[10,2]`. 



```{r, echo=FALSE, fig.width=10, fig.height=5}

default.plot()
plot.mean.sem.adj(AcPFbUbins, 10, 6, 8, report.col, report.names, "Open duration (hours)", 60)
legend.top(sem.names,  kz.col)

temp = as.data.frame(table(AcPFbUbins[,7], AcPFbUbins[,9]))

```


Figure 6: The duration students had their report feedback open for the level 1 course (Report 0: n=`r temp[1,3]`, Report 1: n=`r temp[3,3]`, Report 2: n=`r temp[5,3]`, Report 3: n=`r temp[7,3]`) and for the level 2 course (Report 1: n=`r temp[4,3]`, Report 2: n=`r temp[6,3]`). Data are expressed as the mean+/-SEM time for which each report was open, in hours.


```{r, echo=FALSE, fig.width=12, fig.height=5}

x = my.logs(-4, 9, 4, 10)
p = project.names.formative[c(1,4,8,9)]

default.plot()
par(mfrow=c(1,2))

for(i in 1:2) { 
  hist(log(subset(AcPFbUbins, project == p[i])[,10]), main = "", ylab = "Number of students", xlab = "Open duration (log scale)", xlim=c(-4,9),  ylim=c(0, 200), axes=F)
axis(1, at=seq(-4, 9, 1), labels = x)
axis(2)
}
for(i in 3:4) {
  hist(log(subset(AcPFbUbins, project == p[i])[,10]), main = "", ylab = "Number of students", xlab = "Open duration (log scale)", xlim=c(-4,9),  ylim=c(0, 50), axes=F)
axis(1, at=seq(-4, 9, 1), labels = x)
axis(2)
}


temp = as.data.frame(table(AcPFbUbins[,6]))

```

Figure 7: The number of students who had their feedback open for various durations following the level one semester one course A) formative report (Report 0: n=`r temp[1,2]`), and B) final report (Report 3: n=`r temp[4,2]`), and the level two semester one course C) first report (Report 1: n=`r temp[8,2]`), and C) final report (Report 2: n=`r temp[9,2]`). Data are presented as a frequency histogram showing the number of student across the log transformed open duration. 


```{r, echo=FALSE, fig.width=10, fig.height=5}

default.plot()
plot.mean.sem.adj(FbU, 15, 21, 4, report.col, report.names, "Pause duration (min)", 60000)
legend.top(sem.names,  kz.col)

temp = as.data.frame(table(AcPFbUbins[,7], AcPFbUbins[,9]))

```


Figure 8: Duration for which students pause between clicks when interacting with feedback for the level 1 course (Report 0: n=`r temp[1,3]`, Report 1: n=`r temp[3,3]`, Report 2: n=`r temp[5,3]`, Report 3: n=`r temp[7,3]`) and for the level 2 course (Report 1: n=`r temp[4,3]`, Report 2: n=`r temp[6,3]`). Data are expressed as the mean+/-SEM time that students paused between clicks for each report, in minutes


```{r, echo=FALSE, fig.width=10, fig.height=5}

default.plot()
plot.mean.sem(AcP, 5, 6, 100, report.col, report.names, "Report mark (%)")
legend.top(sem.names,  kz.col)

temp = as.data.frame(table(AcP[,7], AcP[,9]))

```


Figure 9: Overall final mark for reports in the level 1 course (Report 0: n=`r temp[1,3]`, Report 1: n=`r temp[3,3]`, Report 2: n=`r temp[5,3]`, Report 3: n=`r temp[7,3]`) and for the level 2 course (Report 1: n=`r temp[4,3]`, Report 2: n=`r temp[6,3]`). Data are expressed as the mean+/-SEM mark that students achieved for each report, as a percentage.


```{r, echo=FALSE}
#proportion of audio played
FbP.audio = subset(FbP, AnnotType == "Recording")
#NB found error - 45 audio files have NA for duration
#FbP.audio[(which(is.na(FbP.audio$Duration.sec))),]
FbP.audio = FbP.audio[,c(1,2,5,10,12,14:18)]

FbU.audio = subset(FbU, Interaction == "Audio")
FbU.audio$Filename = gsub(".mp3", ".m4a", FbU.audio$Filename)
FbU.audio = FbU.audio[,c(1:2,10,12,16:20)]

FbP.FbU.audio = merge(FbP.audio, FbU.audio, by="Filename", all.x=T)

#surprisingly 2 of the NA duration audio were scrubbed and paused see EventID 123877, 123931, 123932
#FbP.FbU.audio[(which(is.na(FbP.FbU.audio$Duration.sec))),]

FbP.FbU.audio = remover(FbP.FbU.audio, 5)
FbP.FbU.audio = rename(FbP.FbU.audio, 2, "SubmissionID")
FbP.FbU.audio.openbins = merge(FbP.FbU.audio, AcPFbUbins[,c(1,5,10,11)], by="SubmissionID")
FbP.FbU.audio.opened = subset(FbP.FbU.audio.openbins, open.bin !="unopened")

b = with(FbP.FbU.audio.opened, table(SubmissionID, Filename))

with(FbP.FbU.audio.opened, table(report, State))
with(FbP.FbU.audio.opened, addmargins(table(State)))
FbP.FbU.audio.opened[1:5,]
FbP.FbU.audio[1:5,]
with(FbP.FbU.audio, addmargins(table(State)))
m = FbP.FbU.audio[(which(is.na(FbP.FbU.audio$State))),]
m[seq(1,15000,500),]
```


