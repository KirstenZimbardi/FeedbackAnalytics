---
title: "UQM paper outputs"
author: "KZ"
date: "29 June 2015"
output: html_document
---
  

```{r, echo=FALSE, message=FALSE}
#clean workspace
rm(list=ls())

#packages
require(reshape2)
require(dplyr)

#load functions
source("UQM functions.R")
source("HelperFunctions.R")

ProjectID = read.csv("./Data Stage 1/ProjectIDs.csv")
projects()
graphs()


#load data
folder = "./Data Stage 2/"
demog = uqm.csv("demog")
AcP = uqm.csv("AcPdf")
FbPsum = uqm.csv("FbPsummary")
FbP = uqm.csv("FbPdf")
FbU = uqm.csv("FbUdf")
AcPFbUbins = uqm.csv("AcPFbUbins")
SubID.index = uqm.csv("SubIDindex")

#Generalising
demog = gen(demog, 13, 14)
AcP = gen(AcP, 7, 8)
FbP = gen(FbP, 15, 16)
FbU = gen(FbU, 22, 23)
AcPFbUbins = gen(AcPFbUbins, 7, 8)
SubID.index = gen(SubID.index, 4, 5)
#FbPsum does not inlude project details, need to merge in from AcP
#FbP.sum = merge(FbPsum, AcP, by="SubmissionID", all.y=T)
#FbP.sum[which(is.na(FbP.sum[,2])),] #bunch of Submissions for which there are marks but no meta-data on Fb provision - possible error in generating FbPsummary?
#ignoring this for now and just generating Fig 2-4 based on data that is in FbPsummary.csv
FbP.AcP = merge(FbPsum, AcP, by="SubmissionID")

```


#Methods
##Student cohort  
```{r, echo=FALSE}
df = subset(demog, Course.Grade !="withrawn")
temp = df %>% group_by(course, sem) %>% tally()
temp2 = as.data.frame(round(prop.table(table(df[,5])),2)*100)

df[,4] = as.Date(df[,4], "%d/%M/%Y")
sem1 = as.Date("2013-03-01")
#t5 = t5 %>% mutate(finished.p = round((finished/Recording)*100),0)
df2 = df %>% select(Date.of.Birth) 
df2 = df2 %>% mutate(age = (sem1 - Date.of.Birth))
df2$age = as.numeric(df2[,2])%/%365
#df2[1:10,]
#table(df2[,3])
bins = c(0, 16, 21, 60)
df2$age.bin = cut(df2[,2], bins)
#head(df2, n=20)
temp3 = as.data.frame(round(prop.table(table(df2$age.bin)),2)*100)

temp4 = as.data.frame(round(prop.table(table(df$International.Indicator.Code)),2)*100)
#temp4 = as.data.frame(round(prop.table(table(df$International.Indicator.Code)),2)*100)
#round(prop.table(table(df$UQ.Translated.Base.OP)),2)*100

bin.op = c(0, 8, 20)

temp5 = as.data.frame(round(prop.table(table(cut(df$UQ.Translated.Base.OP, bin.op))),2)*100)

```


During the period of this study, there were `r temp[1,3]` and `r temp[2,3]` students enrolled in the level 1 course, and `r temp[3,3]` and `r temp[3,3]` students enrolled in the level 2 course in 2013 Semesters 1 and 2, respectively. There were slightly more `r tolower(temp2[1,1])` (`r temp2[1,2]`%) than `r tolower(temp2[2,1])` (`r temp2[2,2]`%)  students, the vast majority (`r temp3[2,2]`%) were 17 – 21 years old, domestic students (`r temp4[1,2]`%), with high- to mid-range university entry scores (`r temp5[1,2]`%). 


**_need to get program data to check the following:_**    
Just over half (53%) of the students taking these courses were enrolled in a three-year Bachelor of Science (BSc) or four-year dual degree combining BSc with another degree, or the Bachelor of Biomedical Science (four year research-focused program). An additional 21% were enrolled in one of four sports science degrees, and 12% were enrolled in the combined BSc/Medical program (in which students undertake an accelerated two-year BSc program and then enter a four-year, graduate entry Medical program). The remaining students were enrolled in a large range of single and dual degrees (e.g. Arts, Engineering), specialty degrees and applied science degrees.  


##Data collection and analysis  
```{r, echo=FALSE}
temp = length(unique(AcP$SubmissionID))
```
A total of `r temp` reports submitted and marked through FACS in semester 1 and 2, 2013 were used for this study. The modality, length (in time or number of words) and position of each feedback annotation provided on all reports was recorded, and the time taken to mark each collated. Clickstream data logs were collected as students accessed their marked documents, providing information on opening dates and durations, and student interaction with the feedback annotations. Data on student academic performance for each report were also collated. Throughout this study, quantitative analyses were performed using R 3.1.1 (R Development Core Team, Auckland, NZ). The results were expressed as mean and standard error of the mean (SEM), and were considered significant if p<0.05. 

#Results and Discussion    
```{r, echo=FALSE, warning=FALSE, message=FALSE}
temp = dcast(AcP, course + sem ~ report)
#temp
df = subset(demog, Course.Grade !="withrawn")
temp2 = as.data.frame(df %>% group_by(course) %>% tally())
```

The increasing availability of online technologies, which allow the provision of multimodal feedback annotations that can be generalised or situated, has certainly increased the variety and flexibility of feedback delivery options (refs). However, it has also increased the variability of feedback provision and changed the way in which students interact with feedback, leading to potentially greater variability in student outcomes (refs). The primary aims of this study were to understand how the different modalities of feedback available through online technologies affected feedback provisionboth across successive student assessment tasks and within large cohorts with multiple markers, and to examine the way students interacted with the feedback provided. Analyses of FACS data from laboratory reports submitted for assessment (Table 1) in two biomedical science courses in level 1 (n = `r temp2[1,2]` students) and level 2 (n = `r temp2[2,2]`), in Semesters 1 and 2, 2013, have shown that there are significant differences in the ways in which markers use the different modalities of feedback (Figure 2-4). In addition, the data demonstrates that there are substantial differences in the way students interact with their marked reports and feedback within them across the semesters (Figures 5-8).

Table 1: Number of assignments processed through FACS  
```{r, echo=FALSE}
temp
```
NB Report 4 for the level 1 course in semester 2 was administered by another academic department which did not participate in the FACS trial.


```{r, echo=FALSE}
stats = stats.mean.sem(FbP, 18, 4)
stats = round(stats,1)

stats2 = stats.mean.sem(FbP.AcP, 4, 15)
stats2 = round(stats2,1)
#stats2
stats3 = stats.mean.sem(FbP.AcP, 5, 15)
stats3 = round(stats3,1)
#stats3

df = subset(FbP, AnnotType == "Recording" | AnnotType == "Text")
t = t.test(df[,18] ~ df[,4])
t$p.value = tp(t)
#t$p.value

df2 = subset(FbP.AcP, course == "Level 1")
df2 = df2 %>% select(SubmissionID, Recording, Text)
#head(df2)
df2 = melt(df2, id=c("SubmissionID"))
t2 = t.test(df2[,3] ~ df2[,2])
t2$p.value = tp(t2)

df2 = subset(FbP.AcP, course == "Level 2")
df2 = df2 %>% select(SubmissionID, Recording, Text)
#head(df2)
df2 = melt(df2, id=c("SubmissionID"))
t3 = t.test(df2[,3] ~ df2[,2])
t3$p.value = tp(t3)

df = subset(FbP, AnnotType == "Recording" | AnnotType == "Text")
df.1 = subset(df, course == "Level 1")
t4 = t.test(df.1[,18] ~ df.1[,4])
t4$p.value = tp(t4)

df.2 = subset(df, course == "Level 2")
t5 = t.test(df.2[,18] ~ df.2[,4])
t5$p.value = tp(t5)

```

##Feedback Provision
A randomly selected sample of 160 audio annotations were transcribed and their word count determined. Talking speed was relatively stable across audio annotations, as they contained on average 164+/-6 words per minute, which is also consistent with previous reports of 450-500 words per 3 minute audio feedback comment (Brearley and Cullen 2012). To allow comparison between word length of typed and audio annotations, the length (in minutes) of each audio annotation was multiplied by 164, with audio annotations on average containing significantly more words (`r stats[3,1]`+/-`r stats[3,2]` words) than typed annotations (`r stats[4,1]`+/-`r stats[4,2]` words; p`r t$p.value`) (Figure 4). In the first years’ reports, markers provided on average a significantly greater number of typed annotations (`r stats3[1,1]`+/-`r stats3[1,2]`) than audio annotations (`r stats2[1,1]`+/-`r stats2[1,2]`; p`r t2$p.value`; Figure 2). This was reversed on the second years’ reports, where markers provided significantly more audio annotations (`r stats2[2,1]`+/-`r stats2[2,2]`) than typed annotations (`r stats3[2,1]`+/-`r stats3[2,2]`; p`r t3$p.value`; Figure 2). However, for both first (p`r t4$p.value`) and second (p`r t5$p.value`) years’ reports, the total amount of feedback provided in audio annotations, in terms of word length, was significantly greater than typed annotations (Figure 3). 


```{r, echo=FALSE}
df = FbP.AcP
t = t.test(df[,4] ~ df[,15])
t$p.value = tp(t)

df2 = subset(FbP, AnnotType == "Recording")
t2 = t.test(df2[,18] ~ df2[,15])
t2$p.value = tp(t2)

stats = stats.mean.sem(df2, 18, 15)
stats = round(stats,1)

df3 = subset(FbP, AnnotType == "Text")
t3 = t.test(df3[,18] ~ df3[,15])
t3$p.value = tp(t3)

stats3 = stats.mean.sem(df3, 18, 15)
stats3 = round(stats3,1)

t4 = t.test(FbP[,18] ~ FbP[,15])
t4$p.value = tp(t4)

stats4 = stats.mean.sem(FbP, 18, 15)
stats4 = round(stats4,1)
```


When comparing between year levels, it was found that markers provided significantly more audio annotations on second years’ work on average than on the first years’ reports (p`r t$p.value`; Figure 2), the annotations were also slightly, but significantly longer (`r stats[2,1]`+/-`r stats[2,2]` words; p`r t2$p.value`) than those provided to first year students (`r stats[1,1]`+/-`r stats[1,2]` words). In contrast, on the first year students reports markers provided more, significantly longer (`r stats3[1,1]`+/-`r stats3[1,2]` words) text annotations than for second years reports, who had fewer, shorter text annotations (`r stats3[2,1]`+/-`r stats3[2,2]` words; p`r t3$p.value`). Despite this, the total amount of feedback provided on second years’ work (`r stats4[2,1]`+/-`r stats4[2,2]` words) was significantly greater than that on first years’ reports (`r stats4[1,1]`+/-`r stats4[1,2]` words; p`r t4$p.value`; Figure 4A & B), *with audio annotations making up a significantly larger proportion of the total feedback provided on the second years’ reports* [DELETE? REPETITVE?]. *Reports from second year students also took longer to mark (mean+/-SEM) than first years’ reports (mean+/-SEM; p<0.05).* [DONT HAVE THIS DATA ON HAND] This may be related to the differences in task design between first and second year, with the second years’ reports being of greater average length (1909+/-150) than the first years’ reports (1269+/-99), or may reflect that the higher expectations of scientific reasoning for second year students require more detailed explanation by markers (ref APE paper). 


```{r, echo=FALSE, fig.width=10, fig.height=5}

plot.topper.dual()

plot.mean.sem(FbP.AcP, 4, 14, 20, report.col, report.names, "Number of audio annotations per report")
plot.mean.sem(FbP.AcP, 5, 14, 20, report.col, report.names, "Number of text annotations per report")

legend.top(sem.names,  kz.col)

temp = as.data.frame(table(FbP.AcP[,15], FbP.AcP[,17]))

```

Figure 2: Number of audio and text annotations for level 1 course (Report 0: n=`r temp[1,3]`, Report 1: n=`r temp[3,3]`, Report 2: n=`r temp[5,3]`, Report 3: n=`r temp[7,3]`) and for the level 2 course (Report 1: n=`r temp[4,3]`, Report 2: n=`r temp[6,3]`). Shown is the A)  mean+/-SEM number of audio annotations per report across two semesters of level 1 and 2 subjects; B)  mean+/-SEM number of text annotations per report across two semesters of level 1 and 2 subjects.


```{r, echo=FALSE, fig.width=10, fig.height=5}

audio = subset(FbP, AnnotType == "Recording")
text = subset(FbP, AnnotType == "Text")

plot.topper.dual()

plot.mean.sem(audio, 18, 14, 170, report.col, report.names, "Number of words per audio annotation \n per report")
plot.mean.sem(text, 18, 14, 17, report.col, report.names, "Number of words per text annotation \n per report")

legend.top(sem.names,  kz.col)

temp = as.data.frame(table(FbP.AcP[,15], FbP.AcP[,17]))

#Kay wanted range of audio durations (sec) for later text
#temp3 = as.data.frame(tapply(FbP[,12], FbP[,14], mean, na.rm=T))
#temp4 = NULL
#for(i in 1:11)
#  temp4[[i]] = se(subset(FbP, project == project.names.formative[i]), 12)
#temp3
#temp4  
  
```

Figure 3: Number of words provided in each audio and text annotation for level 1 course (Report 0: n=`r temp[1,3]`, Report 1: n=`r temp[3,3]`, Report 2: n=`r temp[5,3]`, Report 3: n=`r temp[7,3]`) and for the level 2 course (Report 1: n=`r temp[4,3]`, Report 2: n=`r temp[6,3]`). Shown is the A) mean+/-SEM number of words in each audio annotation in reports across two semesters and levels; B) mean+/-SEM number of words in each text annotation in reports across two semesters and two levels. *NB The y-axis scale for A is 10x the y-axis scale for B.*


```{r, echo=FALSE, fig.width=10, fig.height=5}

plot.topper.dual()

plot.mean.sem(FbP.AcP, 8, 14, 1700, report.col, report.names, "Number of words in audio annotations per report")
plot.mean.sem(FbP.AcP, 9, 14, 170, report.col, report.names, "Number of words in text annotations per report")

legend.top(sem.names,  kz.col)

temp = as.data.frame(table(FbP.AcP[,15], FbP.AcP[,17]))

```

Figure 4: Total amount of feedback provided in audio and text feedback for level 1 course (Report 0: n=`r temp[1,3]`, Report 1: n=`r temp[3,3]`, Report 2: n=`r temp[5,3]`, Report 3: n=`r temp[7,3]`) and for the level 2 course (Report 1: n=`r temp[4,3]`, Report 2: n=`r temp[6,3]`). Shown is the A) mean+/-SEM number of words in audio annotations in reports across two semesters and levels; B) mean+/-SEM number of words in text annotations in reports across two semesters and two levels. *NB The y-axis scale for A is 10x the y-axis scale for B.*




```{r, echo=FALSE, fig.width=10, fig.height=5}

looked = as.data.frame(addmargins(prop.table(table(AcPFbUbins[,6], AcPFbUbins[,11]),1)))
looked = round(100-(looked[37:47,3]*100),2)
#looked

default.plot()

barplot(looked, names = report.names, las=2, col=report.col, ylim=c(0,100), ylab="Number of Students (% of cohort)", axis.lty=1.0)

legend.top(sem.names,  kz.col)


temp = as.data.frame(table(AcP[,6]))


```


Figure 5: The proportion of students who looked at their feedback (shown as the proportion of students who received feedback in each cohort). Number of students in each cohort: Level one semester 1: n=`r temp[1,2]`; Level one semester 2: n=`r temp[5,2]`; Level two semester 1: n=`r temp[8,2]`; Level two semester 2: n=`r temp[10,2]`. 



```{r, echo=FALSE, fig.width=10, fig.height=5}

default.plot()
plot.mean.sem.adj(AcPFbUbins, 10, 6, 8, report.col, report.names, "Open duration (hours)", 60)
legend.top(sem.names,  kz.col)

temp = as.data.frame(table(AcPFbUbins[,7], AcPFbUbins[,9]))

```


Figure 6: The duration students had their report feedback open for the level 1 course (Report 0: n=`r temp[1,3]`, Report 1: n=`r temp[3,3]`, Report 2: n=`r temp[5,3]`, Report 3: n=`r temp[7,3]`) and for the level 2 course (Report 1: n=`r temp[4,3]`, Report 2: n=`r temp[6,3]`). Data are expressed as the mean+/-SEM time for which each report was open, in hours.


```{r, echo=FALSE, fig.width=12, fig.height=5}

x = my.logs(-4, 9, 4, 10)
p = project.names.formative[c(1,4,8,9)]

default.plot()
par(mfrow=c(1,2))

for(i in 1:2) { 
  hist(log(subset(AcPFbUbins, project == p[i])[,10]), main = "", ylab = "Number of students", xlab = "Open duration (log scale)", xlim=c(-4,9),  ylim=c(0, 200), axes=F)
axis(1, at=seq(-4, 9, 1), labels = x)
axis(2)
}
for(i in 3:4) {
  hist(log(subset(AcPFbUbins, project == p[i])[,10]), main = "", ylab = "Number of students", xlab = "Open duration (log scale)", xlim=c(-4,9),  ylim=c(0, 50), axes=F)
axis(1, at=seq(-4, 9, 1), labels = x)
axis(2)
}


temp = as.data.frame(table(AcPFbUbins[,6]))

```

Figure 7: The number of students who had their feedback open for various durations following the level one semester one course A) formative report (Report 0: n=`r temp[1,2]`), and B) final report (Report 3: n=`r temp[4,2]`), and the level two semester one course C) first report (Report 1: n=`r temp[8,2]`), and C) final report (Report 2: n=`r temp[9,2]`). Data are presented as a frequency histogram showing the number of student across the log transformed open duration. 


```{r, echo=FALSE, fig.width=10, fig.height=5}

default.plot()
plot.mean.sem.adj(FbU, 15, 21, 4, report.col, report.names, "Pause duration (min)", 60000)
legend.top(sem.names,  kz.col)

temp = as.data.frame(table(AcPFbUbins[,7], AcPFbUbins[,9]))

```


Figure 8: Duration for which students pause between clicks when interacting with feedback for the level 1 course (Report 0: n=`r temp[1,3]`, Report 1: n=`r temp[3,3]`, Report 2: n=`r temp[5,3]`, Report 3: n=`r temp[7,3]`) and for the level 2 course (Report 1: n=`r temp[4,3]`, Report 2: n=`r temp[6,3]`). Data are expressed as the mean+/-SEM time that students paused between clicks for each report, in minutes


```{r, echo=FALSE, fig.width=10, fig.height=5}

default.plot()
plot.mean.sem(AcP, 5, 6, 100, report.col, report.names, "Report mark (%)")
legend.top(sem.names,  kz.col)

temp = as.data.frame(table(AcP[,7], AcP[,9]))

```


Figure 9: Overall final mark for reports in the level 1 course (Report 0: n=`r temp[1,3]`, Report 1: n=`r temp[3,3]`, Report 2: n=`r temp[5,3]`, Report 3: n=`r temp[7,3]`) and for the level 2 course (Report 1: n=`r temp[4,3]`, Report 2: n=`r temp[6,3]`). Data are expressed as the mean+/-SEM mark that students achieved for each report, as a percentage.


```{r, echo=FALSE}
#proportion of audio played
FbP.audio = subset(FbP, AnnotType == "Recording")
#NB found error - 45 audio files have NA for duration
#FbP.audio[(which(is.na(FbP.audio$Duration.sec))),]
FbP.audio = FbP.audio[,c(1,2,5,10,12,14:18)]

FbU.audio = subset(FbU, Interaction == "Audio")
FbU.audio$Filename = gsub(".mp3", ".m4a", FbU.audio$Filename)
FbU.audio = FbU.audio[,c(1:2,10,12,16:20)]

FbP.FbU.audio = merge(FbP.audio, FbU.audio, by="Filename", all.x=T)

#surprisingly 2 of the NA duration audio were scrubbed and paused see EventID 123877, 123931, 123932
#FbP.FbU.audio[(which(is.na(FbP.FbU.audio$Duration.sec))),]

FbP.FbU.audio = remover(FbP.FbU.audio, 5)
FbP.FbU.audio = rename(FbP.FbU.audio, 2, "SubmissionID")
FbP.FbU.audio.openbins = merge(FbP.FbU.audio, AcPFbUbins[,c(1,5,10,11)], by="SubmissionID")
FbP.FbU.audio.opened = subset(FbP.FbU.audio.openbins, open.bin !="unopened")

b = with(FbP.FbU.audio.opened, table(SubmissionID, Filename))

with(FbP.FbU.audio.opened, table(report, State))
with(FbP.FbU.audio.opened, addmargins(table(State)))
FbP.FbU.audio.opened[1:5,]
FbP.FbU.audio[1:5,]
with(FbP.FbU.audio, addmargins(table(State)))
m = FbP.FbU.audio[(which(is.na(FbP.FbU.audio$State))),]
m[seq(1,15000,500),]
```


